<nav class="main-header navbar navbar-expand-md navbar-dark" style="background-color: var(--title-bar-color);">
  <!-- Inline CSS -->
  <style>
    .asset-panel {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0.25rem 0.5rem;
      background-color: #f8f9fa;
      border-radius: 999px;
      color: #000 !important;
    }
    .asset-panel img {
      width: 20px;
      height: 20px;
    }
    .update-jupiter-btn {
      border: none;
      background: none;
      cursor: pointer;
      padding: 0.25rem;
    }
    .update-jupiter-btn img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }
    .price-icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
      background-color: #f8f9fa;
    }
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    .spin {
      animation: spin 1s linear infinite;
    }
  </style>

  <div class="container">
    <!-- Navbar Toggler -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsible Nav Items -->
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav">
        <!-- Dashboard -->
        <li class="nav-item">
          <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link">
            <i class="fas fa-home"></i>
          </a>
        </li>
        <!-- Positions Table -->
        <li class="nav-item">
          <a href="{{ url_for('positions.positions_table') }}" class="nav-link">
            <i class="fas fa-table"></i>
          </a>
        </li>
        <!-- Alert Limit Settings -->
        <li class="nav-item">
          <a href="{{ url_for('alerts_bp.alert_config_page') }}" class="nav-link">
            <i class="fas fa-bell"></i>
          </a>
        </li>
        <!-- Alert Matrix -->
        <li class="nav-item">
          <a href="{{ url_for('alerts_bp.alert_matrix') }}" class="nav-link">
            <i class="fas fa-th"></i>
          </a>
        </li>
        <!-- Hedge Calculator -->
        <li class="nav-item">
          <a href="{{ url_for('sonic_labs.hedge_calculator') }}" class="nav-link">
            <span style="font-size:1.2em;">ü¶î</span>
          </a>
        </li>
      </ul>

      <!-- Right Side Items -->
      <ul class="navbar-nav ms-auto">
        <!-- Layout Toggle -->
        <li class="nav-item">
          <a href="#" class="nav-link" id="layoutToggle" title="Toggle Layout">
            <i class="fas fa-arrows-alt-h"></i>
          </a>
        </li>
        <!-- Timers -->
        <li class="nav-item d-none d-md-flex align-items-center me-3">
          <span id="callTimer" class="me-2">‚òé Call: --</span>
          <span id="snoozeTimer">‚è≥ Snooze: --</span>
        </li>
        <!-- Price Panel -->
        <li class="nav-item d-none d-md-flex align-items-center me-3">
          <div class="d-flex gap-2">
            <div class="asset-panel">
              <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=023" alt="BTC">
              <span id="btcPrice">$--.--</span>
              <small id="btcChange" class="fw-bold">0.00%</small>
            </div>
            <div class="asset-panel">
              <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png?v=023" alt="ETH">
              <span id="ethPrice">$--.--</span>
              <small id="ethChange" class="fw-bold">0.00%</small>
            </div>
            <div class="asset-panel">
              <img src="https://cryptologos.cc/logos/solana-sol-logo.png?v=023" alt="SOL">
              <span id="solPrice">$--.--</span>
              <small id="solChange" class="fw-bold">0.00%</small>
            </div>
          </div>
        </li>
        <!-- Jupiter Update Button (for positions) -->
        <li class="nav-item d-flex align-items-center me-3">
          <button type="button" class="update-jupiter-btn" id="updateJupiterBtn" title="Update Positions">
            <img src="{{ url_for('static', filename='images/jupiter.jpg') }}" alt="Update Jupiter">
          </button>
        </li>
        <!-- Prices Update Button (for prices only) -->
        <li class="nav-item d-flex align-items-center me-3">
          <button type="button" class="update-jupiter-btn" id="updatePricesBtn" title="Update Prices">
            <span class="price-icon">$</span>
          </button>
        </li>
        <!-- Gear Dropdown -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="gearDropdown" role="button"
             data-bs-toggle="dropdown" aria-expanded="false" title="Navigation">
            <i class="fas fa-cog"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="gearDropdown">
            <li>
              <a class="dropdown-item" href="../cyclone/cyclone.html">
                <i class="fas fa-cyclone me-1"></i> Cyclone Dashboard
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{{ url_for('dashboard.database_viewer') }}">
                <i class="fas fa-database me-1"></i> Database Viewer
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="{{ url_for('system_config_page') }}">
                <i class="fas fa-cog me-1"></i> System Config
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{{ url_for('dashboard.theme_setup') }}">
                <i class="fas fa-palette me-1"></i> Theme Config
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Inline JavaScript -->
<script>
  // 1) Timers
  function getRemaining(start, period) {
    if (!start) return period;
    const elapsed = Math.floor(Date.now() / 1000) - start;
    return Math.max(period - elapsed, 0);
  }
  fetch('{{ url_for("dashboard.get_alert_limits") }}')
    .then(r => r.json())
    .then(data => {
      const callPeriod = data.call_refractory_period;
      const snoozeCount = data.snooze_countdown;
      const callStart = data.call_refractory_start;
      const snoozeStart = data.snooze_start;
      function updateTimers() {
        document.getElementById('callTimer').textContent =
          `‚òé Call: ${getRemaining(callStart, callPeriod)}`;
        document.getElementById('snoozeTimer').textContent =
          `‚è≥ Snooze: ${getRemaining(snoozeStart, snoozeCount)}`;
      }
      updateTimers();
      setInterval(updateTimers, 1000);
    })
    .catch(err => console.error('Timer error:', err));

  // 2) Price Updates (Client-side display updates)
  function updatePrices() {
    fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana&vs_currencies=usd&include_24hr_change=true')
      .then(r => r.json())
      .then(data => {
        document.getElementById('btcPrice').textContent =
          '$' + data.bitcoin.usd.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const btcChange = data.bitcoin.usd_24h_change.toFixed(2);
        const btcChangeElem = document.getElementById('btcChange');
        btcChangeElem.textContent = btcChange + '%';
        btcChangeElem.style.color = btcChange >= 0 ? 'green' : 'red';
        document.getElementById('ethPrice').textContent =
          '$' + data.ethereum.usd.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const ethChange = data.ethereum.usd_24h_change.toFixed(2);
        const ethChangeElem = document.getElementById('ethChange');
        ethChangeElem.textContent = ethChange + '%';
        ethChangeElem.style.color = ethChange >= 0 ? 'green' : 'red';
        document.getElementById('solPrice').textContent =
          '$' + data.solana.usd.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const solChange = data.solana.usd_24h_change.toFixed(2);
        const solChangeElem = document.getElementById('solChange');
        solChangeElem.textContent = solChange + '%';
        solChangeElem.style.color = solChange >= 0 ? 'green' : 'red';
      })
      .catch(err => console.error('Price fetch error:', err));
  }
  updatePrices();
  setInterval(updatePrices, 60000);

  // 3) Jupiter Update (for positions)
  const updateJupiterBtn = document.getElementById("updateJupiterBtn");
  if (updateJupiterBtn) {
    updateJupiterBtn.addEventListener("click", () => {
      updateJupiterBtn.querySelector("img").classList.add("spin");
      fetch("/positions/update_jupiter?source=User", { method: "POST" })
        .then(r => r.json())
        .then(() => window.location.reload())
        .catch(err => {
          updateJupiterBtn.querySelector("img").classList.remove("spin");
          console.error("Jupiter update error:", err);
        });
    });
  }

  // 4) Prices Update (for prices only)
  const updatePricesBtn = document.getElementById("updatePricesBtn");
  if (updatePricesBtn) {
    updatePricesBtn.addEventListener("click", () => {
      updatePricesBtn.querySelector(".price-icon").classList.add("spin");
      fetch("/prices/update?source=User", { method: "POST" })
        .then(r => r.json())
        .then(() => window.location.reload())
        .catch(err => {
          updatePricesBtn.querySelector(".price-icon").classList.remove("spin");
          console.error("Prices update error:", err);
        });
    });
  }

  // 5) Theme Switcher (if applicable in dropdown)
  document.querySelectorAll('.theme-profile-option').forEach(option => {
    option.addEventListener('click', e => {
      e.preventDefault();
      const profileKey = e.currentTarget.dataset.profile;
      fetch('{{ url_for("dashboard.save_theme_route") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ selected_profile: profileKey })
      })
      .then(r => r.json())
      .then(data => data.success ? window.location.reload() : alert("Theme Error: " + data.error))
      .catch(err => alert("Theme Switch Error: " + err));
    });
  });

  // 6) Layout Toggle Switch
  document.getElementById('layoutToggle').addEventListener('click', function(e) {
    e.preventDefault();
    var mode = localStorage.getItem("layoutMode") || "fluid";
    var newMode = (mode === "fluid") ? "fixed" : "fluid";
    localStorage.setItem("layoutMode", newMode);
    window.location.reload();
  });
</script>
<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  .spin {
    animation: spin 1s linear infinite;
  }
</style>
